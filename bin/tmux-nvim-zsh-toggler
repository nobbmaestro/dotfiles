#!/bin/bash
#
# Tmux nvim-zsh toggler
#
# This script will toggle between nvim and zsh window. If nvim is not running, the script will run nvim as new window 
# from current path with loaded .envrc if applicable. If zsh is not running (as separate window), the script will 
# initialize zsh in a new window.
#
# Dependencies: 
#   required: tmux, nvim
#   optional: direnv

init_cache() {
	if [ -e "$cache" ]; then
		rm "$cache"
	fi
	mkdir -p "$(dirname "$cache")" && touch "$cache"
}

update_cache() {
	local idx=$1 name=$2

	# Cache only if the caller has changed
	if [[ "$(tail -1 "$cache")" != "$idx:$name" ]]; then
		echo "$idx:$name" >>"$cache"
	fi
}

get_cached_caller() {
	local matches

	# Obtain all cached window associated with window name, i.e., '$1'
	matches="$(grep "$1" "$cache" | sort --unique | sort -r)"

	# Find the most recent cached window that is still active
	while read -r line; do
		if [[ "$list_windows" == *"$line"* ]]; then
			cached_caller="$line"
			break
		fi
	done <<<"$matches"
}

init_nvim() {
	if [ ! -d "$1" ]; then
		exit 1
	fi

	# if direnv is installed, load env prior to running nvim
	if type "direnv" >/dev/null 2>&1; then
		tmux neww -c "$1" zsh -c "direnv exec /'$1' zsh -c nvim"
	else
		tmux neww -c "$1" zsh -c "nvim"
	fi
}

# Make sure tmux is running
tmux_running="$(pgrep tmux)"
if [[ -z "$TMUX" ]] && [[ -z "$tmux_running" ]]; then
	echo "tmux needs to be running"
	exit 1
fi

list_windows="$(tmux list-windows -F "#I:#W")"
session_name="$(tmux display-message -p "#S")"
window_name="$(tmux display-message -p "#W")"
window_idx="$(tmux display-message -p "#I")"

cache="$HOME/.cache/tmux/tmux-nvim-zsh-toggler/$session_name.cache"

# Make sure 'nvim' window exists
if [[ "$list_windows" != *"nvim"* ]]; then
	init_cache
	update_cache "$window_idx" "$window_name"
	pane_id="$(tmux display-message -p "#I")"
	pane_path="$(tmux display-message -p -t "$pane_id" '#{pane_current_path}')"
	init_nvim "$pane_path"

# Make sure 'zsh' window exists
elif [[ "$list_windows" != *"zsh"* ]]; then
	update_cache "$window_idx" "$window_name"
	tmux new-window

else
	update_cache "$window_idx" "$window_name"

	# Select destination based on current window
	case "$window_name" in
	nvim)
		get_cached_caller "zsh"
		;;
	*)
		get_cached_caller "nvim"
		;;
	esac

	# Verify that cache did non yield empty destination
	if [[ -n "$cached_caller" ]]; then
		window_dst=$(eval echo "$cached_caller" | cut -d ':' -f 1)

	else
		if [ "$window_name" == "nvim" ]; then
			window_dst="zsh"
		else
			window_dst="nvim"
		fi
	fi
	tmux switch-client -t "$session_name"":$window_dst"
fi
